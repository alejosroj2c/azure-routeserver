# Review the IPtables rules enforced by using the following link:
https://raw.githubusercontent.com/dmauser/azure-routeserver/main/ars-nhip/script/iptables.sh

# Can az-spk1-lxvm reach az-spk2-lxvm?
# Access Bastion or Serial console on az-spk1-lxvm:
# Run the following
ping 10.0.12.4 -c 5
sudo hping3 10.0.12.4 -S -p 80 -c 10
curl 10.0.12.4
# Check also from the opposite side. From az-spk2-lxvm to az-spk1-lxvm.
ping 10.0.11.4 -c 5
sudo hping3 10.0.11.4 -S -p 80 -c 10
curl 10.0.11.4

# Run TCP traceroute to check BGP ECMP first hop NVA1 and NVA2 may change.
# Run command below multiple times to see IP change on the first hop (NVAs).
# from az-spk1-lxvm
tcptraceroute 10.0.12.4 80
# from az-spk2-lxvm
tcptraceroute 10.0.11.4 80

# (OPTIONAL) Review IPtables and start network captures running on both NVA1 and NVA2
sudo iptables -L -v #review Forward IP table rules
sudo tcpdump -n host 10.0.11.4 and host 10.0.12.4

# ********* Turn off one of the NVAs above and re-run the same tests:
echo Check Spoke VMs Route tables:
echo $Azurespoke1Name-lxvm &&\
az network nic show --resource-group $rg -n $Azurespoke1Name-lxvm-nic --query "ipConfigurations[].privateIpAddress" -o tsv &&\
az network nic show-effective-route-table --resource-group $rg -n $Azurespoke1Name-lxvm-nic -o table
echo $Azurespoke2Name-lxvm &&\
az network nic show --resource-group $rg -n $Azurespoke2Name-lxvm-nic --query "ipConfigurations[].privateIpAddress" -o tsv &&\
az network nic show-effective-route-table --resource-group $rg -n $Azurespoke2Name-lxvm-nic -o table
# Can az-spk1-lxvm1 reach az-spk2-lxvm2?
# Access Bastion or Serial console on az-SPK1-lxvm:
# Run the following to SPK2-lxvm1
ping 10.0.12.4
sudo hping3 10.0.12.4 -S -p 80 -c 10
curl 10.0.12.4

# Access Bastion or Serial console on az-SPK2-lxvm:
# Run the following
ping 10.0.11.4
sudo hping3 10.0.11.4 -S -p 80 -c 10
curl 10.0.11.4

# ===========> Bring back the NVA and make sure both are up and running.