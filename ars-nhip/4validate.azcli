#Parameters
rg=lab-ars-nhip #Define your resource group
nvaname=nva
#Define parameters for Azure Hub and Spokes:
AzurehubName=az-hub #Azure Hub Name
Azurespoke1Name=az-spk1 #Azure Spoke 1 name
Azurespoke2Name=az-spk2 #Azure Spoke 1 name

# Check Spoke VMs route tables
echo Load Balancer IP: &&\
 az network lb show -g $rg --name $AzurehubName-$nvaname-ilb --query "frontendIpConfigurations[0].privateIpAddress" -o tsv &&\
echo Check Spoke VMs Route tables: &&\
echo $Azurespoke1Name-lxvm &&\
 az network nic show --resource-group $rg -n $Azurespoke1Name-lxvm-nic --query "ipConfigurations[].privateIpAddress" -o tsv &&\
 az network nic show-effective-route-table --resource-group $rg -n $Azurespoke1Name-lxvm-nic -o table
echo $Azurespoke2Name-lxvm &&\
 az network nic show --resource-group $rg -n $Azurespoke2Name-lxvm-nic --query "ipConfigurations[].privateIpAddress" -o tsv &&\
 az network nic show-effective-route-table --resource-group $rg -n $Azurespoke2Name-lxvm-nic -o table

# Can az-spk1-lxvm1 reach az-spk2-lxvm2?
# Access Bastion or Serial console on az-SPK1-lxvm:
# Run the following to SPK2-lxvm1
ping 10.0.12.4
sudo hping3 10.0.12.4 -S -p 80 -c 10
curl 10.0.12.4

# Access Bastion or Serial console on az-SPK2-lxvm:
# Run the following
ping 10.0.11.4
sudo hping3 10.0.11.4 -S -p 80 -c 10
curl 10.0.11.4



#Run tcptraceroute to check NVA instances intercepting the traffic via Load Balancer.
# Run command below multiple times to see IP change on the first hop (NVAs).
# from az-spk1-lxvm
tcptraceroute 10.0.12.4 80
# from az-spk2-lxvm
tcptraceroute 10.0.11.4 80

#Route Server specific settings:

#Route Server config
# RS instance IPs
az network routeserver list --resource-group $rg --query '{IPs:[].virtualRouterIps}' -o tsv
# RS BGP Peerings
az network routeserver peering list --resource-group $rg --routeserver $AzurehubName-routeserver -o table 
# RS advertised routes to NVA1 and NVA2
for nva in $(az vm list -g $rg --query '[?contains(name,`'$nvaname'`)].name' -o tsv)
do
  echo Advertised routes from RS $AzurehubName-routeserver to $nva
  az network routeserver peering list-advertised-routes \
   --resource-group $rg \
   --name $nva \
   --routeserver $AzurehubName-routeserver \
   --query "[RouteServiceRole_IN_0,RouteServiceRole_IN_1][]" \
   --output table
  echo -e
done

# RS learned routes
for nva in $(az vm list -g $rg --query '[?contains(name,`'$nvaname'`)].name' -o tsv)
do
  echo Learned routes on RS $AzurehubName-routeserver from $nva
  az network routeserver peering list-learned-routes \
   --resource-group $rg \
   --name $nva \
   --routeserver $AzurehubName-routeserver \
   --query "[RouteServiceRole_IN_0,RouteServiceRole_IN_1][]" \
   --output table
  echo -e
done


